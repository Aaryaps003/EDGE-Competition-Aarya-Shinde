<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>üìä Live Election Results</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>
<style>
  :root{--blue:#2b7bff;--bg:#f5f8ff;--card:#ffffff;--muted:#667;--ink:#0f172a;--pill:#eef3ff;--highlight:#e6ffe6}
  *{box-sizing:border-box} body{font-family:Segoe UI,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  .nav{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06);position:sticky;top:0;z-index:10}
  .brand{font-weight:700} .links a{color:#0b63ff;text-decoration:none;margin:0 6px;padding:8px 12px;background:var(--pill);border-radius:10px}
  .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
  .banner{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#fff;padding:16px 20px;border-radius:14px;display:flex;justify-content:space-between;align-items:center;gap:12px;box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .pill{background:rgba(255,255,255,.22);padding:6px 12px;border-radius:999px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin:18px 0}
  .card{background:var(--card);border-radius:14px;padding:16px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  .card h3{margin:0;font-size:14px;color:var(--muted)} .val{font-size:24px;margin-top:6px}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.06)}
  th,td{padding:12px 10px;text-align:center;border-bottom:1px solid #eee} th{background:#f0f5ff;color:#222} tr:last-child td{border-bottom:none}
  .muted{color:var(--muted)} .ts{margin-top:10px;color:var(--muted);font-size:12px}
  .filters{margin:12px 0;display:flex;gap:10px;justify-content:center;align-items:center}
  input,select{padding:8px 10px;border:1px solid #d0d0d0;border-radius:8px;font-size:14px}
  .leader-row{background:var(--highlight);animation:glow 1.5s infinite alternate}
  @keyframes glow{from{box-shadow:0 0 0px #00ff00}to{box-shadow:0 0 12px #00cc00}}
</style>
</head>
<body>
  <div class="nav">
    <div class="brand">üó≥Ô∏è Election Commission</div>
    <div class="links">
      <a href="admin.html">Admin</a>
      <a href="vote.html">Vote</a>
      <a href="results.html">Results</a>
      <a href="map.html">Map</a>
    </div>
  </div>

<div class="wrap">
  <div class="banner">
    <div>
      <div class="pill">Live</div>
      <h1>Election Results Dashboard</h1>
      <div class="muted">Auto-updating via WebSocket</div>
    </div>
    <div id="leaderBox" class="pill" style="font-weight:600">Leader: ‚Äî</div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <input id="search" placeholder="üîç Search by name or party" oninput="applyFilters()">
    <select id="constFilter" onchange="applyFilters()">
      <option value="">All Constituencies</option>
    </select>
    <select id="sort" onchange="applyFilters()">
      <option value="desc">Sort by votes ‚Üì</option>
      <option value="asc">Sort by votes ‚Üë</option>
    </select>
  </div>

  <div class="grid">
    <div class="card"><h3>Total Voters</h3><div id="totalVoters" class="val">‚Äî</div></div>
    <div class="card"><h3>Voted</h3><div id="voted" class="val">‚Äî</div></div>
    <div class="card"><h3>Turnout</h3><div id="turnout" class="val">‚Äî</div></div>
    <div class="card"><h3>Total Votes</h3><div id="totalVotes" class="val">‚Äî</div></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Candidate ID</th>
        <th>Name</th>
        <th>Party</th>
        <th>Constituency</th>
        <th>Votes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="ts" id="timestamp">Last updated ‚Äî</div>
</div>

<script>
  let allCandidates = [];
  let leaderId = null;

  async function loadResults() {
    const [resRes, statRes] = await Promise.all([ fetch('/api/results'), fetch('/api/stats') ]);
    allCandidates = await resRes.json();
    populateConstituencies();
    applyFilters();
    const stats = await statRes.json();
    renderStats(stats);
    document.getElementById('timestamp').textContent = 'Last updated ' + new Date().toLocaleTimeString();
  }

  function populateConstituencies() {
    const select = document.getElementById('constFilter');
    const constituencies = [...new Set(allCandidates.map(c => c.constituency))].sort();
    select.innerHTML = '<option value="">All Constituencies</option>';
    constituencies.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; select.appendChild(opt); });
  }

  function applyFilters() {
    const searchVal = document.getElementById('search').value.trim().toLowerCase();
    const sortVal = document.getElementById('sort').value;
    const constVal = document.getElementById('constFilter').value;

    let filtered = allCandidates.filter(c =>
      (c.name.toLowerCase().includes(searchVal) || c.party.toLowerCase().includes(searchVal)) &&
      (constVal === '' || c.constituency === constVal)
    );

    filtered.sort((a,b) => sortVal === 'asc' ? a.voteCount - b.voteCount : b.voteCount - a.voteCount);
    renderTable(filtered);
  }

  function renderTable(rows) {
    const tb = document.getElementById('tbody');
    tb.innerHTML = '';
    if (!rows || rows.length === 0) { tb.innerHTML = '<tr><td colspan="5">No candidates found.</td></tr>'; return; }

    const maxVotes = Math.max(...rows.map(r => r.voteCount));
    const topCandidate = rows.find(r => r.voteCount === maxVotes);
    leaderId = topCandidate?.candidateId || null;

    rows.forEach(r => {
      tb.innerHTML += `<tr class="${r.candidateId === leaderId ? 'leader-row' : ''}">
        <td>${r.candidateId}</td>
        <td>${r.name}</td>
        <td>${r.party}</td>
        <td>${r.constituency}</td>
        <td><b>${r.voteCount}</b></td>
      </tr>`;
    });
  }

  function renderStats(s) {
    document.getElementById('totalVoters').textContent = s.totalVoters ?? 0;
    document.getElementById('voted').textContent = s.votersVoted ?? 0;
    document.getElementById('turnout').textContent = (s.turnoutPercent ?? 0).toFixed(1) + '%';
    document.getElementById('totalVotes').textContent = s.totalVotes ?? 0;

    const leader = (s.leadingCandidateName ? `${s.leadingCandidateName} (${s.leadingCandidateParty}) ‚Äî ${s.leadingVotes}` : '‚Äî');
    document.getElementById('leaderBox').textContent = 'Leader: ' + leader;
  }

  (function initWS(){
    try{
      const sock = new SockJS('/liveResults');
      const stomp = Stomp.over(sock);
      stomp.connect({}, () => { stomp.subscribe('/topic/results', () => loadResults()); });
    }catch(e){ console.warn('WS not available', e); }
  })();

  loadResults();
</script>
</body>
</html>
